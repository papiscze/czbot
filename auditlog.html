<!DOCTYPE html>
<html lang="cs" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Audit Log</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        /* P≈ÆVODN√ç STYLY - ZACHOV√ÅNY */
        body { background: #1e1e2d; color: #d1d1d1; font-family: 'Poppins', sans-serif; }
        .header-section { background: #2a2a3e; padding: 20px 0; border-bottom: 2px solid #5a5a7a; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); }
        .log-container { background: #2a2a3e; border-radius: 12px; padding: 20px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); }
        h1 { color: #57F287; font-weight: 700; }
        .filter-card { background: #1e1e2d; border: 1px solid #3a3a5a; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .filter-category-title { font-weight: 600; color: #3498db; cursor: pointer; }
        .event-filter-checkbox { margin-right: 5px; }
        
        /* Styl pro jednotliv√Ω ≈ô√°dek logu */
        .log-item { 
            border-bottom: 1px solid #3a3a5a; 
            padding: 10px 0; 
        }
        .log-item:last-child { border-bottom: none; }
        .log-timestamp { font-size: 0.8rem; color: #9faab7; min-width: 100px; }
        .log-content { flex-grow: 1; padding-left: 15px; }

        /* Spinner a zpr√°vy */
        #loadingMessage, #errorMessage {
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .form-select, .form-control { border-color:#5a5a7a; background-color:#2a2a3e !important; color:#d1d1d1 !important; }
        .form-check-input:checked { background-color: #57F287; border-color: #57F287; }

        /* NOV√â STYLY pro zobrazen√≠ JSON dat */
        .log-action-text { font-weight: 600; margin-bottom: 5px; }
        .log-changes-title { 
            font-size: 0.9rem;
            color: #d1d1d1;
            cursor: pointer;
            padding: 5px 0;
            display: block;
            margin-top: 5px;
        }
        .log-changes-detail {
            background: #1e1e2d; /* Tmav≈°√≠ pozad√≠ pro detaily */
            padding: 10px;
            border-radius: 6px;
            margin-top: 5px;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
        }
        
    </style>
</head>
<body>

<header class="header-section text-center">
    <div class="container">
        <a href="/api/auth/discord" class="btn btn-outline-info rounded-pill position-absolute top-0 end-0 mt-3 me-3" id="authButton" title="P≈ôihl√°sit znovu p≈ôes Discord.">
            <i class="bi bi-discord me-2"></i> P≈ôihl√°sit se
        </a>
        <h1 class="display-5 fw-bold"><i class="bi bi-journal-text me-3"></i> Audit Log</h1>
        <p class="lead text-secondary mt-2" id="serverInfo">Naƒç√≠t√°m servery...</p>
    </div>
</header>

<main class="container py-5">
    
    <div class="row g-4">
        <div class="col-lg-3">
            <div class="filter-card">
                <label for="guildSelect" class="form-label fw-bold"><i class="bi bi-server me-2"></i> Vybrat Server</label>
                <select id="guildSelect" class="form-select" onchange="handleGuildChange()">
                    <option value="">Naƒç√≠t√°n√≠ server≈Ø...</option>
                </select>
            </div>

            <div class="filter-card">
                <label for="searchInput" class="form-label fw-bold"><i class="bi bi-search me-2"></i> Vyhled√°v√°n√≠ (Search)</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Moder√°tor, C√≠l, D≈Øvod, ID..." onkeyup="if(event.key === 'Enter') loadLog(1)">
                <small class="text-secondary">Stisknƒõte Enter pro vyhled√°n√≠.</small>
            </div>

            <div class="filter-card">
                <label for="timeFilter" class="form-label fw-bold"><i class="bi bi-clock me-2"></i> ƒåasov√© obdob√≠ (Ignorov√°no API)</label>
                <select id="timeFilter" class="form-select">
                    <option value="1h">Posledn√≠ 1 hodina</option>
                    <option value="6h">Posledn√≠ch 6 hodin</option>
                    <option value="12h">Posledn√≠ch 12 hodin</option>
                    <option value="24h" selected>Posledn√≠ch 24 hodin</option>
                </select>
            </div>

            <div class="filter-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="form-label fw-bold"><i class="bi bi-funnel me-2"></i> Filtrovat Ud√°losti (Ignorov√°no API)</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleAllCheckboxes(true)">V≈°e</button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleAllCheckboxes(false)">≈Ω√°dn√©</button>
            </div>
                <div id="eventFilters">
                    </div>
                <button class="btn btn-sm btn-success w-100 mt-3" onclick="loadLog(1)">Pou≈æ√≠t Filtry / Hled√°n√≠</button>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="log-container">
                <div id="loadingMessage" class="text-info" style="display: none;">
                    <div class="spinner-border mb-3" role="status"></div>
                    <p>Naƒç√≠t√°m logy...</p>
                </div>
                
                <div id="errorMessage" class="text-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle-fill fs-3 mb-2"></i>
                    <p id="errorText">Nastala chyba p≈ôi naƒç√≠t√°n√≠ dat.</p>
                </div>

                <div id="logContent">
                    <p class="text-center text-secondary pt-5">Vyberte server pro zobrazen√≠ Audit Logu.</p>
                </div>

                <div class="d-flex justify-content-center mt-4">
                    <nav>
                        <ul class="pagination" id="pagination">
                            </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // **************** KL√çƒåOV√Å ZMƒöNA 1: Pevnƒõ nastaven√° URL ****************
    const API_BASE_URL = "https://rs422cznas.myds.me:5038";
    
    let currentGuildId = null;
    let currentPage = 1;
    // P≈Øvodn√≠ logLimit byl 20. Zmƒõnƒõno na 100, co≈æ je maximum, kter√© va≈°e API (pravdƒõpodobnƒõ) vrac√≠ v jednom vol√°n√≠ bez str√°nkov√°n√≠.
    const logLimit = 100; 

    // --- Mapa ud√°lost√≠ pro zobrazen√≠ ---
    // P≈Øvodn√≠ mapa z va≈°eho k√≥du je roz≈°√≠≈ôena o Discord Audit Log akce
    const ACTION_MAP = {
        // Zpr√°vy
        'message_delete': { name: 'Smazan√° zpr√°va', icon: 'üóëÔ∏è', color: 'text-danger' },
        'message_edit': { name: 'Upraven√° zpr√°va', icon: '‚úçÔ∏è', color: 'text-warning' },
        
        // U≈æivatel√© a Moderace (ƒåasto Discord Audit Log akce)
        'member_join': { name: 'P≈ôipojen√≠ u≈æivatele', icon: 'üëã', color: 'text-success' },
        'member_leave': { name: 'Odchod u≈æivatele', icon: 'üö∂', color: 'text-secondary' },
        'member_update': { name: '√öprava u≈æivatele (role/nick)', icon: 'üë§', color: 'text-warning' },
        'member_ban': { name: 'Zabanov√°n√≠ u≈æivatele', icon: 'üö´', color: 'text-danger' },
        'member_unban': { name: 'Odbanov√°n√≠ u≈æivatele', icon: '‚úÖ', color: 'text-success' },
        'member_kick': { name: 'Vyhozen√≠ u≈æivatele', icon: 'üë¢', color: 'text-danger' },
        'member_timeout': { name: 'Timeout u≈æivatele', icon: '‚è±Ô∏è', color: 'text-danger' },
        
        // Kan√°ly a Role (Discord Audit Log akce)
        'channel_create': { name: 'Vytvo≈ôen√≠ kan√°lu', icon: '‚ûï', color: 'text-success' },
        'channel_update': { name: '√öprava kan√°lu', icon: '‚úèÔ∏è', color: 'text-warning' },
        'channel_delete': { name: 'Smaz√°n√≠ kan√°lu', icon: '‚ûñ', color: 'text-danger' },
        'role_create': { name: 'Vytvo≈ôen√≠ role', icon: '‚ú®', color: 'text-success' },
        'role_update': { name: '√öprava role', icon: 'üîß', color: 'text-warning' },
        'role_delete': { name: 'Smaz√°n√≠ role', icon: 'üí•', color: 'text-danger' },

        // Ostatn√≠ akce
        'guild_update': { name: '√öprava serveru', icon: '‚öôÔ∏è', color: 'text-warning' },
        'emoji_update': { name: '√öprava emotikon≈Ø', icon: 'üòÄ', color: 'text-warning' },
        'invite_create': { name: 'Vytvo≈ôen√≠ pozv√°nky', icon: 'üì®', color: 'text-success' },
        
        // Z√°stupn√° akce pro nezn√°m√© typy
        'default': { name: 'Discord Akce', icon: '‚ùì', color: 'text-secondary' },
        'command_usage': { name: 'Pou≈æit√≠ p≈ô√≠kazu', icon: '‚úÖ', color: 'text-info' },
    };


    // --- Mapa ud√°lost√≠ (P≈ÆVODN√ç - zachov√°na pouze pro UI logiku zobrazen√≠ filtr≈Ø) ---
    const EVENT_CATEGORIES = {
        "Zpr√°vy": { "description": "Ud√°losti t√Ωkaj√≠c√≠ se zpr√°v.", "events": { "message_delete": {"name": "üóëÔ∏è Smazan√© zpr√°vy"}, "message_edit": {"name": "‚úçÔ∏è Upraven√© zpr√°vy"}, } },
        "U≈æivatel√© a Moderace": { "description": "Ud√°losti t√Ωkaj√≠c√≠ se u≈æivatel≈Ø a moder√°torsk√Ωch akc√≠.", "events": { "member_join": {"name": "üëã P≈ôipojen√≠ u≈æivatele"}, "member_leave": {"name": "üö∂ Odchod u≈æivatele"}, "member_update": {"name": "üë§ √öprava u≈æivatele (role/nick)"}, "member_ban": {"name": "üö´ Zabanov√°n√≠ u≈æivatele"}, "member_unban": {"name": "‚úÖ Odbanov√°n√≠ u≈æivatele"}, "member_kick": {"name": "üë¢ Vyhozen√≠ u≈æivatele"}, "member_timeout": {"name": "‚è±Ô∏è Timeout u≈æivatele"}, "member_server_mute": {"name": "üîá Ztlumen√≠ mikrofonu u≈æivatele"}, "member_server_unmute": {"name": "üîä Odtlumen√≠ mikrofonu u≈æivatele"}, "member_server_deafen": {"name": "üîï Ztlumen√≠ sluch√°tek u≈æivatele"}, "member_server_undeafen": {"name": "üîî Odtlumen√≠ sluch√°tek u≈æivatele"}, } },
        "Hlasov√© kan√°ly a P√≥dium": { "description": "Ud√°losti v hlasov√Ωch kan√°lech a f√°z√≠ch.", "events": { "voice_state_update": {"name": "üé§ Hlasov√© aktivity"}, "stage_instance_create": {"name": "üéôÔ∏è P√≥dium vytvo≈ôeno"}, "stage_instance_delete": {"name": "‚úñÔ∏è P√≥dium smaz√°no"}, "stage_instance_update": {"name": "üìù P√≥dium upraveno"}, } },
        "Role a Kan√°ly": { "description": "Ud√°losti t√Ωkaj√≠c√≠ se rol√≠ a textov√Ωch/hlasov√Ωch kan√°l≈Ø.", "events": { "role_create": {"name": "‚ú® Vytvo≈ôen√≠ role"}, "role_delete": {"name": "üí• Smaz√°n√≠ role"}, "channel_create": {"name": "‚ûï Vytvo≈ôen√≠ kan√°lu"}, "channel_delete": {"name": "‚ûñ Smaz√°n√≠ kan√°lu"}, "channel_update": {"name": "‚úèÔ∏è √öprava kan√°lu"}, } },
        "Server a Pozv√°nky": { "description": "Obecn√© ud√°losti serveru a pozv√°nek.", "events": { "guild_update": {"name": "‚öôÔ∏è √öprava serveru"}, "emoji_update": {"name": "üòÄ √öprava emotikon≈Ø"}, "invite_create": {"name": "üì® Vytvo≈ôen√≠ pozv√°nky"}, "invite_delete": {"name": "üóëÔ∏è Smaz√°n√≠ pozv√°nky"}, "webhooks_update": {"name": "üîó Webhooky aktualizov√°ny"}, } },
        "Vl√°kna a Ud√°losti": { "description": "Ud√°losti t√Ωkaj√≠c√≠ se vl√°ken a pl√°novan√Ωch ud√°lost√≠ serveru.", "events": { "thread_create": {"name": "üí¨ Vl√°kno vytvo≈ôeno"}, "thread_update": {"name": "‚úèÔ∏è Vl√°kno upraveno"}, "thread_delete": {"name": "‚ùå Vl√°kno smaz√°no"}, "scheduled_event_create": {"name": "üóìÔ∏è Ud√°lost vytvo≈ôena"}, "scheduled_event_update": {"name": "‚úçÔ∏è Ud√°lost upravena"}, "scheduled_event_delete": {"name": "üóëÔ∏è Ud√°lost smaz√°na"}, } },
        "Aktivity bota": { "description": "Ud√°losti t√Ωkaj√≠c√≠ se interakc√≠ s botem.", "events": { "command_usage": {"name": "‚úÖ Pou≈æit√≠ p≈ô√≠kazu"}, } },
    };


    // --- Funkce pro zobrazen√≠/skryt√≠ prvk≈Ø (ponech√°no beze zmƒõny) ---
    function showLoading() {
        document.getElementById('logContent').innerHTML = '';
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('loadingMessage').style.display = 'flex';
        document.getElementById('pagination').innerHTML = '';
    }

    function showError(message) {
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('logContent').innerHTML = '';
        document.getElementById('errorText').textContent = message;
        document.getElementById('errorMessage').style.display = 'flex';
        document.getElementById('pagination').innerHTML = '';
    }

    function hideMessages() {
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';
    }

    // --- Generov√°n√≠ Filtr≈Ø (P≈ÆVODN√ç - zachov√°no pro UI) ---
    function generateEventFilters() {
        const container = document.getElementById('eventFilters');
        let html = '';

        for (const categoryName in EVENT_CATEGORIES) {
            const category = EVENT_CATEGORIES[categoryName];
            const collapseId = `collapse-${categoryName.replace(/\s/g, '-')}`;

            html += `
                <div class="mb-3">
                    <a class="filter-category-title d-block" data-bs-toggle="collapse" href="#${collapseId}" role="button" aria-expanded="false" aria-controls="${collapseId}">
                        ${categoryName}
                        <i class="bi bi-chevron-down float-end"></i>
                    </a>
                    <div class="collapse" id="${collapseId}">
                        <small class="text-secondary">${category.description}</small>
                        <div class="mt-2">
            `;
            
            for (const eventKey in category.events) {
                const event = category.events[eventKey];
                html += `
                    <div class="form-check">
                        <input class="form-check-input event-filter-checkbox" type="checkbox" value="${eventKey}" id="check-${eventKey}" checked>
                        <label class="form-check-label" for="check-${eventKey}">
                            ${event.name}
                        </label>
                    </div>
                `;
            }

            html += `
                        </div>
                    </div>
                </div>
            `;
        }
        container.innerHTML = html;
    }
    
    function toggleAllCheckboxes(checked) {
        document.querySelectorAll('.event-filter-checkbox').forEach(checkbox => {
            checkbox.checked = checked;
        });
    }

    // --- Z√≠sk√°n√≠ API vol√°n√≠ (P≈ÆVODN√ç - Nyn√≠ nepou≈æ√≠v√°no, ale ponech√°no pro UI/budoucnost) ---
    function getSelectedEventKeys() {
        return Array.from(document.querySelectorAll('.event-filter-checkbox:checked'))
            .map(cb => cb.value)
            .join(',');
    }

    // --- KL√çƒåOV√Å ZMƒöNA 2: Hlavn√≠ funkce naƒç√≠t√°n√≠ Logu upraven√° pro backend loggeru ---
    async function loadLog(page = 1) {
        if (!currentGuildId) return;
        
        // currentPage = page; // Str√°nkov√°n√≠ prozat√≠m ignorujeme, API vrac√≠ pouze top 100

        showLoading();

        // P≈Øvodn√≠: const period = document.getElementById('timeFilter').value;
        // P≈Øvodn√≠: const eventKeys = getSelectedEventKeys();
        // P≈Øvodn√≠: const offset = (currentPage - 1) * logLimit;
        
        // NOV√â: Z√≠sk√°n√≠ vyhled√°vac√≠ho dotazu
        const search = document.getElementById('searchInput').value.trim();

        // NOV√Å URL: Pouze s limitem a vyhled√°v√°n√≠m
        let url = `${API_BASE_URL}/api/auditlog/${currentGuildId}?limit=${logLimit}`;
        if (search) {
            url += `&search=${encodeURIComponent(search)}`;
        }

        try {
            const response = await fetch(url);

            if (response.status === 404) {
                 showError("Bot nen√≠ na serveru, nem√° p≈ô√≠stup k log≈Øm, nebo endpoint neexistuje.");
                return;
            }
            if (response.status === 401) {
                showError("Neautorizov√°no. Zkuste se p≈ôihl√°sit znovu.");
                return;
            }
            if (!response.ok) {
                throw new Error(`Server vr√°til chybu: ${response.status}`);
            }

            // Backend vrac√≠ pole log≈Ø
            const logs = await response.json(); 

            // Vykreslen√≠ Log≈Ø
            renderLogEntries(logs); 
            
            // Str√°nkov√°n√≠ (zat√≠m se nepou≈æije, proto≈æe chyb√≠ total_count)
            // renderPagination(data.total_count || 0);

            hideMessages();

        } catch (e) {
            console.error("Chyba p≈ôi naƒç√≠t√°n√≠ Audit Logu:", e);
            showError(`Nepoda≈ôilo se naƒç√≠st logy: ${e.message}. Zkontrolujte p≈ôipojen√≠ k ${API_BASE_URL}.`);
        }
    }

    // --- KL√çƒåOV√Å ZMƒöNA 3: Vykreslen√≠ Z√°znam≈Ø podle nov√© struktury ---
    function renderLogEntries(logs) {
        const container = document.getElementById('logContent');
        
        // ZDE JE KL√çƒåOV√Å OPRAVA: Kontrola, zda logs je skuteƒçnƒõ pole
        if (!Array.isArray(logs) || logs.length === 0) {
            // M≈Ø≈æe se st√°t, ≈æe API vr√°t√≠ pr√°zdn√Ω objekt, nebo null, proto tato kontrola zabr√°n√≠ p√°du.
            container.innerHTML = '<div class="text-center p-5 text-secondary">≈Ω√°dn√© z√°znamy nebyly nalezeny (nebo API nevr√°tilo platn√© pole dat).</div>';
            return;
        }

        container.innerHTML = logs.map((log, index) => {
            // log.timestamp je UNIX EPOCH (v sekund√°ch)
            const timestamp = new Date(log.timestamp * 1000).toLocaleString('cs-CZ', { dateStyle: 'short', timeStyle: 'medium' });
            
            const actionDetail = ACTION_MAP[log.action] || ACTION_MAP['default'];
            const collapseId = `changes-${index}`;

            // Sestaven√≠ hlavn√≠ zpr√°vy
            let message = `<span class="fw-bold ${actionDetail.color}">${actionDetail.icon} ${actionDetail.name}</span>`;
            
            // C√≠lov√° entita (u≈æivatel, kan√°l, role)
            if (log.target_name && log.target_name !== 'N/A') {
                message += ` na entitƒõ <span class="fw-semibold text-info">${log.target_name}</span>`;
            }
            
            // Moder√°tor (zdroj akce)
            if (log.source_name && log.source_name !== 'N/A') {
                message += ` moder√°torem <span class="fw-semibold text-warning">${log.source_name}</span>.`;
            } else {
                 message += ` (Akce provedena syst√©mem nebo nezn√°m√Ωm zdrojem).`;
            }

            // D≈Øvod
            if (log.reason) {
                message += `<br><small class="text-secondary">D≈Øvod: ${log.reason}</small>`;
            }

            // Zobrazen√≠ detail≈Ø zmƒõn
            let changesHtml = '';
            if (log.changes && log.changes.length > 0) {
                changesHtml = `
                    <a class="log-changes-title" data-bs-toggle="collapse" href="#${collapseId}" role="button" aria-expanded="false" aria-controls="${collapseId}">
                        <i class="bi bi-caret-right-fill me-1"></i> Zobrazit detaily zmƒõn (${log.changes.length})
                    </a>
                    <div class="collapse" id="${collapseId}">
                        <div class="log-changes-detail">
                            ${log.changes.map(change => {
                                // P≈ôevod na hezky form√°tovan√Ω JSON
                                const oldValue = change.old_value !== undefined ? JSON.stringify(change.old_value, null, 2) : 'N/A';
                                const newValue = change.new_value !== undefined ? JSON.stringify(change.new_value, null, 2) : 'N/A';
                                
                                return `
                                    <div class="mb-2">
                                        <span class="text-info fw-bold">${(change.key || 'nezn√°m√Ω kl√≠ƒç').replace(/_/g, ' ')}:</span>
                                        <span class="d-block text-danger">P≈Øvodn√≠: ${oldValue}</span>
                                        <span class="d-block text-success">Nov√°: ${newValue}</span>
                                    </div>
                                `;
                            }).join('<hr class="my-2 border-secondary">')}
                        </div>
                    </div>
                `;
            }

            // P≈Øvodn√≠ rozlo≈æen√≠ ≈ô√°dku logu
            return `
                <div class="log-item">
                    <span class="log-timestamp">${timestamp}</span>
                    <div class="log-content">
                        <div class="log-action-text">${message}</div>
                        ${changesHtml}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // --- Vykreslen√≠ Str√°nkov√°n√≠ (P≈ÆVODN√ç - Zachov√°no pro UI, ale nefunkƒçn√≠ bez total_count) ---
    function renderPagination(totalCount) {
        const paginationUl = document.getElementById('pagination');
        const totalPages = Math.ceil(totalCount / logLimit);
        let html = '';
        
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);

        if (endPage - startPage < 4) {
            if (startPage > 1) startPage = Math.max(1, endPage - 4);
            else if (endPage < totalPages) endPage = Math.min(totalPages, startPage + 4);
        }

        // Tlaƒç√≠tko P≈ôedchoz√≠
        html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                     <a class="page-link" href="#" onclick="loadLog(${currentPage - 1})">P≈ôedchoz√≠</a>
                   </li>`;

        // ƒå√≠sla str√°nek
        for (let i = startPage; i <= endPage; i++) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                         <a class="page-link" href="#" onclick="loadLog(${i})">${i}</a>
                       </li>`;
        }

        // Tlaƒç√≠tko Dal≈°√≠
        html += `<li class="page-item ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}">
                     <a class="page-link" href="#" onclick="loadLog(${currentPage + 1})">Dal≈°√≠</a>
                   </li>`;

        paginationUl.innerHTML = html;
        if (totalPages <= 1) paginationUl.innerHTML = '';
    }


    // --- Logika pro v√Ωbƒõr serveru (Upravena jen b√°ze API) ---
    async function loadInitialData() {
        const select = document.getElementById('guildSelect');
        const authButton = document.getElementById('authButton');
        const serverInfo = document.getElementById('serverInfo');
        
        serverInfo.textContent = 'Kontroluji p≈ôihl√°≈°en√≠...';
        select.innerHTML = `<option value="">Naƒç√≠t√°m servery...</option>`;
        select.disabled = true;

        try {
            const response = await fetch(`${API_BASE_URL}/api/user/authorized_guilds`);

            if (!response.ok) {
                serverInfo.textContent = 'Pro zobrazen√≠ Audit Logu se pros√≠m p≈ôihlaste.';
                authButton.href = `${API_BASE_URL}/api/auth/discord?next=${encodeURIComponent(window.location.pathname)}`;
                authButton.innerHTML = `<i class="bi bi-discord me-2"></i> P≈ôihl√°sit se`;
                return;
            }

            authButton.innerHTML = `<i class="bi bi-arrow-counterclockwise me-2"></i> Obnovit p≈ô√≠stup`;
            
            const authorizedGuilds = await response.json();
            
            if (!authorizedGuilds || authorizedGuilds.length === 0) {
                serverInfo.textContent = 'Nem√°te p≈ô√≠stup k ≈æ√°dn√Ωm server≈Øm s aktivn√≠m botem.';
                select.innerHTML = `<option value="">≈Ω√°dn√© servery</option>`;
                return;
            }
            
            select.innerHTML = authorizedGuilds.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            select.disabled = false;
            
            let initialGuild = authorizedGuilds.find(g => g.id === window.location.pathname.split('/').pop()) || authorizedGuilds[0];
            currentGuildId = initialGuild.id;
            select.value = initialGuild.id;
            window.history.replaceState({ guildId: initialGuild.id }, '', `/auditlog/${initialGuild.id}`);
            serverInfo.textContent = `Audit Log pro server: ${initialGuild.name}`;

            await loadLog();
            
        } catch (e) {
            console.error("Chyba p≈ôi naƒç√≠t√°n√≠ server≈Ø:", e);
            showError(`Nepoda≈ôilo se naƒç√≠st servery: ${e.message}`);
        }
    }

    async function handleGuildChange() {
        const select = document.getElementById('guildSelect');
        const newId = select.value;
        
        if (newId && newId !== currentGuildId) {
            currentGuildId = newId;
            const guildName = select.options[select.selectedIndex].text;
            document.getElementById('serverInfo').textContent = `Audit Log pro server: ${guildName}`;
            
            window.history.pushState({ guildId: newId }, '', `/auditlog/${newId}`);
            
            await loadLog(1);
        }
    }


    // --- Inicializace ---
    document.addEventListener('DOMContentLoaded', () => {
        generateEventFilters();
        loadInitialData();
    });

</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
</body>
</html>
