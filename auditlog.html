<!DOCTYPE html>
<html lang="cs" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Audit Log</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        /* --- JEDNOTNÃ‰ STYLY NAVIGACE --- */
        * {
            box-sizing: border-box;
        }
        body { 
            background: #1e1e2d; 
            color: #d1d1d1; 
            font-family: 'Poppins', sans-serif; 
            padding-top: 56px; 
        }
        .navbar-custom {
            background-color: #2a2a3e;
            border-bottom: 2px solid #5a5a7a;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1030;
        }
        .navbar-toggler-icon {
            filter: invert(1);
        }
        .nav-link.active, .navbar-brand {
            color: #57F287 !important;
            font-weight: 600;
        }
        .nav-link:hover:not(.active) {
            color: #3498db !important;
        }
        .dropdown-menu-custom {
            background-color: #1e1e2d;
            border: 1px solid #5a5a7a;
        }
        .dropdown-item-custom {
            color: #d1d1d1;
        }
        .dropdown-item-custom:hover {
            background-color: #3a3a5a;
            color: #ffffff;
        }
        .dropdown-toggle::after {
            filter: invert(1);
        }
        
        /* --- STYLY SPECIFICKÃ‰ PRO TUTO STRÃNKU (AUDIT LOG) --- */
        .header-section { 
            background: #2a2a3e; 
            padding: 20px 0; 
            border-bottom: 2px solid #5a5a7a; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); 
        }
        .log-container { background: #2a2a3e; border-radius: 12px; padding: 20px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); }
        h1 { color: #57F287; font-weight: 700; }
        .filter-card { background: #1e1e2d; border: 1px solid #3a3a5a; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .filter-category-title { font-weight: 600; color: #3498db; cursor: pointer; }
        .event-filter-checkbox { margin-right: 5px; }
        .log-item { 
            border-bottom: 1px solid #3a3a5a; 
            padding: 10px 0; 
            display: flex;
            align-items: flex-start;
        }
        .log-item:last-child { border-bottom: none; }
        .log-timestamp { 
            font-size: 0.8rem; 
            color: #9faab7; 
            min-width: 100px; 
            flex-shrink: 0;
        }
        .log-content { 
            flex-grow: 1; 
            padding-left: 15px;
        }
        #loadingMessage, #errorMessage {
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .form-select, .form-control { border-color:#5a5a7a; background-color:#2a2a3e !important; color:#d1d1d1 !important; }
        .form-check-input:checked { background-color: #57F287; border-color: #57F287; }

        /* Styly pro zobrazenÃ­ JSON dat */
        .log-action-text { font-weight: 600; margin-bottom: 5px; }
        .log-changes-title { 
            font-size: 0.9rem;
            color: #d1d1d1;
            cursor: pointer;
            padding: 5px 0;
            display: block;
            margin-top: 5px;
        }
        .log-changes-detail {
            background: #1e1e2d; 
            padding: 10px;
            border-radius: 6px;
            margin-top: 5px;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap; 
            overflow-x: auto;
            line-height: 1.2; 
        }
        .log-changes-detail > div {
            margin-bottom: 5px !important; 
        }
        /* ZajiÅ¡tÄ›nÃ­, Å¾e vnitÅ™nÃ­ bloky pro JSON jsou kompaktnÃ­ */
        .log-changes-detail > div > span.d-block {
            padding-left: 5px; /* MÃ­rnÃ© odsazenÃ­ pro Äitelnost */
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <i class="bi bi-robot me-2"></i> Discord Utility Bot
        </a>
        <a href="/api/auth/discord" class="btn btn-outline-info rounded-pill ms-auto me-3 d-none d-lg-block" id="authButtonLg" title="PÅ™ihlÃ¡sit znovu pÅ™es Discord.">
            <i class="bi bi-discord me-2"></i> PÅ™ihlÃ¡sit se
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/crongenerator.html"><i class="bi bi-clock-history me-1"></i> Cron Generator</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/embedgenerator.html"><i class="bi bi-card-heading me-1"></i> Embed Generator</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/commands.html"><i class="bi bi-terminal me-1"></i> PÅ™Ã­kazy</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-server me-1"></i> SprÃ¡va Serveru
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-custom">
                        <li><a class="dropdown-item dropdown-item-custom active" href="/auditlog.html"><i class="bi bi-journal-text me-2"></i> Audit Log</a></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="/stats.html"><i class="bi bi-graph-up me-2"></i> Statistiky</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item dropdown-item-custom" href="#"><i class="bi bi-gear-fill me-2"></i> NastavenÃ­ Bota (WIP)</a></li>
                    </ul>
                </li>
            </ul>
            <a href="/api/auth/discord" class="btn btn-outline-info rounded-pill w-100 mt-2 mb-2 d-lg-none" id="authButtonSm" title="PÅ™ihlÃ¡sit znovu pÅ™es Discord.">
                <i class="bi bi-discord me-2"></i> PÅ™ihlÃ¡sit se
            </a>
        </div>
    </div>
</nav>

<header class="header-section text-center">
    <div class="container">
        <h1 class="display-5 fw-bold"><i class="bi bi-journal-text me-3"></i> Audit Log</h1>
        <p class="lead text-secondary mt-2" id="serverInfo">NaÄÃ­tÃ¡m servery...</p>
    </div>
</header>

<main class="container py-5">
    
    <div class="row g-4">
        <div class="col-lg-3">
            <div class="filter-card">
                <label for="guildSelect" class="form-label fw-bold"><i class="bi bi-server me-2"></i> Vybrat Server</label>
                <select id="guildSelect" class="form-select" onchange="handleGuildChange()">
                    <option value="">NaÄÃ­tÃ¡nÃ­ serverÅ¯...</option>
                </select>
            </div>

            <div class="filter-card">
                <label for="searchInput" class="form-label fw-bold"><i class="bi bi-search me-2"></i> VyhledÃ¡vÃ¡nÃ­ (Search)</label>
                <input type="text" id="searchInput" class="form-control" placeholder="ModerÃ¡tor, CÃ­l, DÅ¯vod, ID..." onkeyup="if(event.key === 'Enter') applyClientFilters()">
                <small class="text-secondary">StisknÄ›te Enter nebo "PouÅ¾Ã­t Filtry".</small>
            </div>

            <div class="filter-card">
                <label for="timeFilter" class="form-label fw-bold"><i class="bi bi-clock me-2"></i> ÄŒasovÃ© obdobÃ­</label>
                <select id="timeFilter" class="form-select">
                    <option value="1h">PoslednÃ­ 1 hodina</option>
                    <option value="6h">PoslednÃ­ch 6 hodin</option>
                    <option value="12h">PoslednÃ­ch 12 hodin</option>
                    <option value="24h" selected>PoslednÃ­ch 24 hodin</option>
                </select>
            </div>

            <div class="filter-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="form-label fw-bold"><i class="bi bi-funnel me-2"></i> Filtrovat UdÃ¡losti</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleAllCheckboxes(true)">VÅ¡e</button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleAllCheckboxes(false)">Å½Ã¡dnÃ©</button>
            </div>
                <div id="eventFilters">
                    </div>
                <button class="btn btn-sm btn-success w-100 mt-3" onclick="applyClientFilters()">PouÅ¾Ã­t Filtry / HledÃ¡nÃ­</button>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="log-container">
                <div id="loadingMessage" class="text-info" style="display: none;">
                    <div class="spinner-border mb-3" role="status"></div>
                    <p>NaÄÃ­tÃ¡m logy...</p>
                </div>
                
                <div id="errorMessage" class="text-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle-fill fs-3 mb-2"></i>
                    <p id="errorText">Nastala chyba pÅ™i naÄÃ­tÃ¡nÃ­ dat.</p>
                </div>

                <div id="logContent">
                    <p class="text-center text-secondary pt-5">Vyberte server pro zobrazenÃ­ Audit Logu.</p>
                </div>

                <div class="d-flex justify-content-center mt-4">
                    <nav>
                        <ul class="pagination" id="pagination">
                            </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // **************** PevnÄ› nastavenÃ¡ URL ****************
    const API_BASE_URL = "https://rs422cznas.myds.me:5038";
    
    let currentGuildId = null;
    let currentPage = 1;
    const logLimit = 100; 
    let allLogs = []; // Pole pro uloÅ¾enÃ­ vÅ¡ech staÅ¾enÃ½ch logÅ¯ (pro klientskÃ© filtrovÃ¡nÃ­)

    // --- Mapa udÃ¡lostÃ­ pro zobrazenÃ­ ---
    const ACTION_MAP = {
        'message_delete': { name: 'SmazanÃ¡ zprÃ¡va', icon: 'ğŸ—‘ï¸', color: 'text-danger' },
        'message_edit': { name: 'UpravenÃ¡ zprÃ¡va', icon: 'âœï¸', color: 'text-warning' },
        'member_join': { name: 'PÅ™ipojenÃ­ uÅ¾ivatele', icon: 'ğŸ‘‹', color: 'text-success' },
        'member_leave': { name: 'Odchod uÅ¾ivatele', icon: 'ğŸš¶', color: 'text-secondary' },
        'member_update': { name: 'Ãšprava uÅ¾ivatele (role/nick)', icon: 'ğŸ‘¤', color: 'text-warning' },
        'member_ban': { name: 'ZabanovÃ¡nÃ­ uÅ¾ivatele', icon: 'ğŸš«', color: 'text-danger' },
        'member_unban': { name: 'OdbanovÃ¡nÃ­ uÅ¾ivatele', icon: 'âœ…', 'color': 'text-success' },
        'member_kick': { name: 'VyhozenÃ­ uÅ¾ivatele', icon: 'ğŸ‘¢', color: 'text-danger' },
        'member_timeout': { name: 'Timeout uÅ¾ivatele', icon: 'â±ï¸', color: 'text-danger' },
        'channel_create': { name: 'VytvoÅ™enÃ­ kanÃ¡lu', icon: 'â•', color: 'text-success' },
        'channel_update': { name: 'Ãšprava kanÃ¡lu', icon: 'âœï¸', color: 'text-warning' },
        'channel_delete': { name: 'SmazÃ¡nÃ­ kanÃ¡lu', icon: 'â–', color: 'text-danger' },
        'role_create': { name: 'VytvoÅ™enÃ­ role', icon: 'âœ¨', color: 'text-success' },
        'role_update': { name: 'Ãšprava role', icon: 'ğŸ”§', color: 'text-warning' },
        'role_delete': { name: 'SmazÃ¡nÃ­ role', icon: 'ğŸ’¥', color: 'text-danger' },
        'guild_update': { name: 'Ãšprava serveru', icon: 'âš™ï¸', color: 'text-warning' },
        'emoji_update': { name: 'Ãšprava emotikonÅ¯', icon: 'ğŸ˜€', color: 'text-warning' },
        'invite_create': { name: 'VytvoÅ™enÃ­ pozvÃ¡nky', icon: 'ğŸ“¨', color: 'text-success' },
        'default': { name: 'Discord Akce', icon: 'â“', color: 'text-secondary' },
        'command_usage': { name: 'PouÅ¾itÃ­ pÅ™Ã­kazu', icon: 'âœ…', color: 'text-info' },
        // DoplnÄ›nÃ­ eventÅ¯
        'member_server_mute': { "name": "ğŸ”‡ ZtlumenÃ­ mikrofonu uÅ¾ivatele", "icon": "ğŸ”‡", "color": "text-danger" }, 
        'member_server_unmute': { "name": "ğŸ”Š OdtlumenÃ­ mikrofonu uÅ¾ivatele", "icon": "ğŸ”Š", "color": "text-success" }, 
        'member_server_deafen': { "name": "ğŸ”• ZtlumenÃ­ sluchÃ¡tek uÅ¾ivatele", "icon": "ğŸ”•", "color": "text-danger" }, 
        'member_server_undeafen': { "name": "ğŸ”” OdtlumenÃ­ sluchÃ¡tek uÅ¾ivatele", "icon": "ğŸ””", "color": "text-success" }, 
        'voice_state_update': { "name": "ğŸ¤ HlasovÃ© aktivity", "icon": "ğŸ¤", "color": "text-info" }, 
        'stage_instance_create': { "name": "ğŸ™ï¸ PÃ³dium vytvoÅ™eno", "icon": "ğŸ™ï¸", "color": "text-success" }, 
        'stage_instance_delete': { "name": "âœ–ï¸ PÃ³dium smazÃ¡no", "icon": "âœ–ï¸", "color": "text-danger" }, 
        'stage_instance_update': { "name": "ğŸ“ PÃ³dium upraveno", "icon": "ğŸ“", "color": "text-warning" }, 
        'invite_delete': { "name": "ğŸ—‘ï¸ SmazÃ¡nÃ­ pozvÃ¡nky", "icon": "ğŸ—‘ï¸", "color": "text-danger" }, 
        'webhooks_update': { "name": "ğŸ”— Webhooky aktualizovÃ¡ny", "icon": "ğŸ”—", "color": "text-info" }, 
        'thread_create': { "name": "ğŸ’¬ VlÃ¡kno vytvoÅ™eno", "icon": "ğŸ’¬", "color": "text-success" }, 
        'thread_update': { "name": "âœï¸ VlÃ¡kno upraveno", "icon": "âœï¸", "color": "text-warning" }, 
        'thread_delete': { "name": "âŒ VlÃ¡kno smazÃ¡no", "icon": "âŒ", "color": "text-danger" }, 
        'scheduled_event_create': { "name": "ğŸ—“ï¸ UdÃ¡lost vytvoÅ™ena", "icon": "ğŸ—“ï¸", "color": "text-success" }, 
        'scheduled_event_update': { "name": "âœï¸ UdÃ¡lost upravena", "icon": "âœï¸", "color": "text-warning" }, 
        'scheduled_event_delete': { "name": "ğŸ—‘ï¸ UdÃ¡lost smazÃ¡na", "icon": "ğŸ—‘ï¸", "color": "text-danger" }, 
    };
    // --- Mapa udÃ¡lostÃ­ pro filtry ---
    const EVENT_CATEGORIES = {
        "ZprÃ¡vy": { "description": "UdÃ¡losti tÃ½kajÃ­cÃ­ se zprÃ¡v.", "events": { "message_delete": {"name": "ğŸ—‘ï¸ SmazanÃ© zprÃ¡vy"}, "message_edit": {"name": "âœï¸ UpravenÃ© zprÃ¡vy"}, } },
        "UÅ¾ivatelÃ© a Moderace": { "description": "UdÃ¡losti tÃ½kajÃ­cÃ­ se uÅ¾ivatelÅ¯ a moderÃ¡torskÃ½ch akcÃ­.", "events": { "member_join": {"name": "ğŸ‘‹ PÅ™ipojenÃ­ uÅ¾ivatele"}, "member_leave": {"name": "ğŸš¶ Odchod uÅ¾ivatele"}, "member_update": {"name": "ğŸ‘¤ Ãšprava uÅ¾ivatele (role/nick)"}, "member_ban": {"name": "ğŸš« ZabanovÃ¡nÃ­ uÅ¾ivatele"}, "member_unban": {"name": "âœ… OdbanovÃ¡nÃ­ uÅ¾ivatele"}, "member_kick": {"name": "ğŸ‘¢ VyhozenÃ­ uÅ¾ivatele"}, "member_timeout": {"name": "â±ï¸ Timeout uÅ¾ivatele"}, "member_server_mute": {"name": "ğŸ”‡ ZtlumenÃ­ mikrofonu uÅ¾ivatele"}, "member_server_unmute": {"name": "ğŸ”Š OdtlumenÃ­ mikrofonu uÅ¾ivatele"}, "member_server_deafen": {"name": "ğŸ”• ZtlumenÃ­ sluchÃ¡tek uÅ¾ivatele"}, "member_server_undeafen": {"name": "ğŸ”” OdtlumenÃ­ sluchÃ¡tek uÅ¾ivatele"}, } },
        "HlasovÃ© kanÃ¡ly a PÃ³dium": { "description": "UdÃ¡losti v hlasovÃ½ch kanÃ¡lech a fÃ¡zÃ­ch.", "events": { "voice_state_update": {"name": "ğŸ¤ HlasovÃ© aktivity"}, "stage_instance_create": {"name": "ğŸ™ï¸ PÃ³dium vytvoÅ™eno"}, "stage_instance_delete": {"name": "âœ–ï¸ PÃ³dium smazÃ¡no"}, "stage_instance_update": {"name": "ğŸ“ PÃ³dium upraveno"}, } },
        "Role a KanÃ¡ly": { "description": "UdÃ¡losti tÃ½kajÃ­cÃ­ se rolÃ­ a textovÃ½ch/hlasovÃ½ch kanÃ¡lÅ¯.", "events": { "role_create": {"name": "âœ¨ VytvoÅ™enÃ­ role"}, "role_delete": {"name": "ğŸ’¥ SmazÃ¡nÃ­ role"}, "channel_create": {"name": "â• VytvoÅ™enÃ­ kanÃ¡lu"}, "channel_delete": {"name": "â– SmazÃ¡nÃ­ kanÃ¡lu"}, "channel_update": {"name": "âœï¸ Ãšprava kanÃ¡lu"}, } },
        "Server a PozvÃ¡nky": { "description": "ObecnÃ© udÃ¡losti serveru a pozvÃ¡nek.", "events": { "guild_update": {"name": "âš™ï¸ Ãšprava serveru"}, "emoji_update": {"name": "ğŸ˜€ Ãšprava emotikonÅ¯"}, "invite_create": {"name": "ğŸ“¨ VytvoÅ™enÃ­ pozvÃ¡nky"}, "invite_delete": {"name": "ğŸ—‘ï¸ SmazÃ¡nÃ­ pozvÃ¡nky"}, "webhooks_update": {"name": "ğŸ”— Webhooky aktualizovÃ¡ny"}, } },
        "VlÃ¡kna a UdÃ¡losti": { "description": "UdÃ¡losti tÃ½kajÃ­cÃ­ se vlÃ¡ken a plÃ¡novanÃ½ch udÃ¡lostÃ­ serveru.", "events": { "thread_create": {"name": "ğŸ’¬ VlÃ¡kno vytvoÅ™eno"}, "thread_update": {"name": "âœï¸ VlÃ¡kno upraveno"}, "thread_delete": {"name": "âŒ VlÃ¡kno smazÃ¡no"}, "scheduled_event_create": {"name": "ğŸ—“ï¸ UdÃ¡lost vytvoÅ™ena"}, "scheduled_event_update": {"name": "âœï¸ UdÃ¡lost upravena"}, "scheduled_event_delete": {"name": "ğŸ—‘ï¸ UdÃ¡lost smazÃ¡na"}, } },
        "Aktivity bota": { "description": "UdÃ¡losti tÃ½kajÃ­cÃ­ se interakcÃ­ s botem.", "events": { "command_usage": {"name": "âœ… PouÅ¾itÃ­ pÅ™Ã­kazu"}, } },
    };
    // --- PomocnÃ© funkce ---
    function showLoading() {
        document.getElementById('logContent').innerHTML = '';
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('loadingMessage').style.display = 'flex';
        document.getElementById('pagination').innerHTML = '';
    }
    function showError(message) {
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('logContent').innerHTML = '';
        document.getElementById('errorText').textContent = message;
        document.getElementById('errorMessage').style.display = 'flex';
        document.getElementById('pagination').innerHTML = '';
    }
    function hideMessages() {
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';
    }
    function generateEventFilters() {
        const container = document.getElementById('eventFilters');
        let html = '';
        for (const categoryName in EVENT_CATEGORIES) {
            const category = EVENT_CATEGORIES[categoryName];
            const collapseId = `collapse-${categoryName.replace(/\s/g, '-')}`;
            html += `
                <div class="mb-3">
                    <a class="filter-category-title d-block" data-bs-toggle="collapse" href="#${collapseId}" role="button" aria-expanded="false" aria-controls="${collapseId}">
                        ${categoryName}
                        <i class="bi bi-chevron-down float-end"></i>
                    </a>
                    <div class="collapse" id="${collapseId}">
                        <small class="text-secondary">${category.description}</small>
                        <div class="mt-2">
            `;
            for (const eventKey in category.events) {
                const event = category.events[eventKey];
                html += `
                    <div class="form-check">
                        <input class="form-check-input event-filter-checkbox" type="checkbox" value="${eventKey}" id="check-${eventKey}" checked>
                        <label class="form-check-label" for="check-${eventKey}">
                            ${event.name}
                        </label>
                    </div>
                `;
            }
            html += `
                        </div>
                    </div>
                </div>
            `;
        }
        container.innerHTML = html;
    }
    
    function toggleAllCheckboxes(checked) {
        document.querySelectorAll('.event-filter-checkbox').forEach(checkbox => {
            checkbox.checked = checked;
        });
    }
    // --- HlavnÃ­ funkce naÄÃ­tÃ¡nÃ­ Logu (staÅ¾enÃ­ dat z API) ---
    async function loadLog() {
        if (!currentGuildId) return;
        showLoading();
        let url = `${API_BASE_URL}/api/auditlogs/${currentGuildId}`; 

        try {
            const response = await fetch(url);

            if (response.status === 404) {
                 showError("Bot nenÃ­ na serveru, nemÃ¡ pÅ™Ã­stup k logÅ¯m, nebo endpoint neexistuje.");
                 return;
            }
            if (response.status === 401) {
                showError("NeautorizovÃ¡no. Zkuste se pÅ™ihlÃ¡sit znovu.");
                return;
            }
            if (!response.ok) {
                throw new Error(`Server vrÃ¡til chybu: ${response.status}`);
            }

            const responseData = await response.json(); 
            // UloÅ¾Ã­me staÅ¾enÃ¡ data pro klientskÃ© filtrovÃ¡nÃ­
            allLogs = Array.isArray(responseData.logs) ? responseData.logs : [];
            
            // Aplikujeme filtry a vykreslÃ­me logy
            applyClientFilters(); 
            hideMessages();

        } catch (e) {
            console.error("Chyba pÅ™i naÄÃ­tÃ¡nÃ­ Audit Logu:", e);
            showError(`NepodaÅ™ilo se naÄÃ­st logy: ${e.message}. Zkontrolujte pÅ™ipojenÃ­ k ${API_BASE_URL}.`);
        }
    }
    // --- FUNKCE PRO KLIENTSKÃ‰ FILTROVÃNÃ ---
    function applyClientFilters(page = 1) {
        currentPage = page;
        let filteredLogs = [...allLogs];
        
        // 1. FILTR ÄŒASOVÃ‰HO OBDOBÃ
        const timeFilterValue = document.getElementById('timeFilter').value;
        let cutOffTime = 0; 
        if (timeFilterValue) {
            
            // â­ OPRAVA: BezpeÄnÄ›jÅ¡Ã­ parsovÃ¡nÃ­ ÄasovÃ© hodnoty (oÄekÃ¡vÃ¡ napÅ™. "1h" nebo "24h")
            const match = timeFilterValue.match(/(\d+)([hd])/i); 
            
            if (match) {
                const amount = parseInt(match[1]);
                const unit = match[2].toLowerCase();

                let ms;
                if (unit === 'h') {
                    ms = amount * 3600000; // Hodiny na milisekundy
                } else if (unit === 'd') {
                    ms = amount * 86400000; // Dny na milisekundy (pÅ™idÃ¡no pro budoucÃ­ rozÅ¡Ã­Å™enÃ­)
                } else {
                    ms = 0; 
                }

                if (ms > 0) {
                    cutOffTime = Date.now() - ms;
                    filteredLogs = filteredLogs.filter(log => new Date(log.timestamp).getTime() >= cutOffTime);
                }
            }
        }
        
        // 2. FILTR UDÃLOSTÃ
        const selectedEventTypes = Array.from(document.querySelectorAll('.event-filter-checkbox:checked')).map(cb => cb.value);
        if (selectedEventTypes.length > 0) {
            filteredLogs = filteredLogs.filter(log => selectedEventTypes.includes(log.action));
        } else {
             // Pokud nenÃ­ nic zaÅ¡krtnuto, nezobrazÃ­me nic
             filteredLogs = [];
        }


        // 3. FILTR VYHLEDÃVÃNÃ (SEARCH)
        const search = document.getElementById('searchInput').value.trim().toLowerCase();
        if (search) {
            filteredLogs = filteredLogs.filter(log => {
                const searchString = [
                    log.user_name,
                    log.target_name,
                    log.action,
                    log.reason,
                    log.user_id,
                    log.target_id
                ].join(' ').toLowerCase();

                return searchString.includes(search);
            });
        } Â 
        // VykreslenÃ­
        renderLogEntries(filteredLogs);
        renderPagination(filteredLogs.length); 
    }
    // --- VykreslenÃ­ StrÃ¡nkovÃ¡nÃ­ (ProzatÃ­m neaktivnÃ­) ---
    function renderPagination(totalCount) {
        const paginationUl = document.getElementById('pagination');
        paginationUl.innerHTML = '';
        if (totalCount === 0) return;
    }
    // --- Funkce VykreslenÃ­ ZÃ¡znamÅ¯ ---
    function renderLogEntries(logs) { 
        const container = document.getElementById('logContent');
        
        if (logs.length === 0) {
            container.innerHTML = '<div class="text-center p-5 text-secondary">Å½Ã¡dnÃ© zÃ¡znamy neodpovÃ­dajÃ­ zvolenÃ½m filtrÅ¯m.</div>';
            return;
        }

        container.innerHTML = logs.map((log, index) => {
            
            const timestamp = new Date(log.timestamp).toLocaleString('cs-CZ', { dateStyle: 'short', timeStyle: 'medium' });
            const actionDetail = ACTION_MAP[log.action] || ACTION_MAP['default'];
            const collapseId = `changes-${index}`;
            
            let changesArray = [];
            let parsedData = {};
            
            if (log.data) {
                try {
                    parsedData = JSON.parse(log.data);
                    for (const key in parsedData) {
                        changesArray.push({
                            key: key,
                            new_value: parsedData[key],
                            old_value: undefined 
                        });
                    }
                } catch (e) {
                    // Ignorujeme chybu parsovÃ¡nÃ­, data nebudou k dispozici
                }
            }

            let message = `<span class="fw-bold ${actionDetail.color}">${actionDetail.icon} ${actionDetail.name}</span>`;
            
            // --- ZJEDNODUÅ ENÃ TEXTU ZPRÃV ---
            if (log.action === 'message_edit') {
                 message += ` v kanÃ¡lu <span class="fw-semibold text-info">${parsedData.channel_name || 'N/A'}</span>.`;
            } else if (log.action === 'message_delete') {
                const channelName = parsedData.channel_name_after || log.channel_id || 'N/A';
                message += ` v kanÃ¡lu <span class="fw-semibold text-info">${channelName}</span>.`;
            } else {
                // StandardnÃ­ text pro ostatnÃ­ akce
                 if (log.target_name && log.target_name !== 'N/A') {
                     message += ` na entitÄ› <span class="fw-semibold text-info">${log.target_name}</span>`;
                 }
                 if (log.user_name && log.user_name !== 'NeznÃ¡mÃ½ USER') {
                     message += ` moderÃ¡torem <span class="fw-semibold text-warning">${log.user_name}</span>.`;
                 } else {
                      message += ` (Akce provedena systÃ©mem nebo neznÃ¡mÃ½m zdrojem).`;
                 }
            }
            // PÅ™idÃ¡nÃ­ moderÃ¡tora pro message_edit
             if (log.action === 'message_edit' && log.user_name && log.user_name !== 'NeznÃ¡mÃ½ USER') {
                 message += ` ModerÃ¡tor: <span class="fw-semibold text-warning">${log.user_name}</span>.`;
             }
            if (log.reason) {
                message += `<br><small class="text-secondary">DÅ¯vod: ${log.reason}</small>`;
            }
            let changesHtml = '';
            if (changesArray.length > 0) {
                
                let renderedMessageEdit = false;
                
                // GenerovÃ¡nÃ­ detailÅ¯ zmÄ›n
                const changeDetails = changesArray.map(change => {
                     if (log.action === 'message_edit' && parsedData.content_before && !renderedMessageEdit) {
                          renderedMessageEdit = true;
                          // Minimalizace mezer
                          return `<div class="mb-2"><span class="text-info fw-bold">UpravenÃ¡ zprÃ¡va v kanÃ¡lu ${parsedData.channel_name || log.channel_id}:</span><span class="d-block text-danger">PÅ™ed: ${parsedData.content_before || 'N/A'}</span><span class="d-block text-success">Po: ${parsedData.content_after || 'N/A'}</span></div>`;
                     }
                     if (log.action === 'message_edit') {
                         return ''; // Ignorujeme duplicitnÃ­ klÃ­Äe
                     }

                    // StandardnÃ­ vykreslenÃ­ ostatnÃ­ch zmÄ›n
                    const oldValue = change.old_value !== undefined ? JSON.stringify(change.old_value, null, 2) : 'N/A';
                    const newValue = change.new_value !== undefined ? JSON.stringify(change.new_value, null, 2) : 'N/A';
                    
                    // Minimalizace mezer
                    return `<div class="mb-2"><span class="text-info fw-bold">${(change.key || 'neznÃ¡mÃ½ klÃ­Ä').replace(/_/g, ' ')}:</span><span class="d-block text-danger">PÅ¯vodnÃ­: ${oldValue}</span><span class="d-block text-success">NovÃ¡: ${newValue}</span></div>`;
                }).filter(item => item !== '').join('<hr class="my-2 border-secondary">'); // OdstranÃ­me prÃ¡zdnÃ© poloÅ¾ky

                changesHtml = `
                    <a class="log-changes-title" data-bs-toggle="collapse" href="#${collapseId}" role="button" aria-expanded="false" aria-controls="${collapseId}">
                        <i class="bi bi-caret-right-fill me-1"></i> Zobrazit detaily zmÄ›n (${changesArray.length})
                    </a>
                    <div class="collapse" id="${collapseId}">
                        <div class="log-changes-detail">
                            ${changeDetails}
                        </div>
                    </div>
                `;
            }

            // Minimalizace mezer
            return `<div class="log-item"><span class="log-timestamp">${timestamp}</span><div class="log-content"><div class="log-action-text">${message}</div>${changesHtml}</div></div>`;
        }).join('');
        
        if (logs.length === 0) {
            container.innerHTML = '<div class="text-center p-5 text-secondary">Å½Ã¡dnÃ© zÃ¡znamy neodpovÃ­dajÃ­ zvolenÃ½m filtrÅ¯m.</div>';
        }
    }
    // --- Logika pro vÃ½bÄ›r serveru s opravenÃ½m pÅ™esmÄ›rovÃ¡nÃ­m ---
    async function loadInitialData() {
        const select = document.getElementById('guildSelect');
        const authButtonLg = document.getElementById('authButtonLg'); 
        const authButtonSm = document.getElementById('authButtonSm'); 
        const serverInfo = document.getElementById('serverInfo');
        
        serverInfo.textContent = 'Kontroluji pÅ™ihlÃ¡Å¡enÃ­...';
        select.innerHTML = `<option value="">NaÄÃ­tÃ¡m servery...</option>`;
        select.disabled = true;

        try {
            const response = await fetch(`${API_BASE_URL}/api/user/authorized_guilds`);
            
            // --- OPRVA ZDE: Definujeme URL pro pÅ™esmÄ›rovÃ¡nÃ­ s pouÅ¾itÃ­m aktuÃ¡lnÃ­ cesty ---
            const currentPath = window.location.pathname;
            const authUrl = `${API_BASE_URL}/api/auth/discord?next=${encodeURIComponent(currentPath)}`;


            if (!response.ok) {
                serverInfo.textContent = 'Pro zobrazenÃ­ Audit Logu se prosÃ­m pÅ™ihlaste.';
                
                authButtonLg.href = authUrl;
                authButtonSm.href = authUrl;
                authButtonLg.innerHTML = `<i class="bi bi-discord me-2"></i> PÅ™ihlÃ¡sit se`;
                authButtonSm.innerHTML = `<i class="bi bi-discord me-2"></i> PÅ™ihlÃ¡sit se`;
                return;
            }

            // Jsme pÅ™ihlÃ¡Å¡eni
            authButtonLg.innerHTML = `<i class="bi bi-arrow-counterclockwise me-2"></i> Obnovit pÅ™Ã­stup`;
            authButtonSm.innerHTML = `<i class="bi bi-arrow-counterclockwise me-2"></i> Obnovit pÅ™Ã­stup`;
            authButtonLg.href = authUrl;
            authButtonSm.href = authUrl;
            
            const authorizedGuilds = await response.json();
            
            if (!authorizedGuilds || authorizedGuilds.length === 0) {
                serverInfo.textContent = 'NemÃ¡te pÅ™Ã­stup k Å¾Ã¡dnÃ½m serverÅ¯m s aktivnÃ­m botem.';
                select.innerHTML = `<option value="">Å½Ã¡dnÃ© servery</option>`;
                return;
            }
            
            select.innerHTML = authorizedGuilds.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            select.disabled = false;
            
            const pathSegments = window.location.pathname.split('/');
            let initialGuildIdFromUrl = pathSegments[pathSegments.length - 1];
            
            let initialGuild = authorizedGuilds.find(g => g.id === initialGuildIdFromUrl);

            if (!initialGuild) {
                initialGuild = authorizedGuilds[0];
                // UjistÃ­me se, Å¾e i pÅ™i prvnÃ­m naÄtenÃ­ se URL sprÃ¡vnÄ› nahradÃ­ pro pÅ™esmÄ›rovÃ¡nÃ­
                window.history.replaceState({ guildId: initialGuild.id }, '', `/auditlog/${initialGuild.id}`);
                // **DÅ¯leÅ¾itÃ©: UpravÃ­me auth URL, aby vedla na konkrÃ©tnÃ­ server**
                const newAuthUrl = `${API_BASE_URL}/api/auth/discord?next=${encodeURIComponent(`/auditlog/${initialGuild.id}`)}`;
                authButtonLg.href = newAuthUrl;
                authButtonSm.href = newAuthUrl;
            } else {
                 // **DÅ¯leÅ¾itÃ©: UpravÃ­me auth URL, aby vedla na konkrÃ©tnÃ­ server**
                const newAuthUrl = `${API_BASE_URL}/api/auth/discord?next=${encodeURIComponent(window.location.pathname)}`;
                authButtonLg.href = newAuthUrl;
                authButtonSm.href = newAuthUrl;
            }
            
            currentGuildId = initialGuild.id;
            select.value = initialGuild.id;
            serverInfo.textContent = `Audit Log pro server: ${initialGuild.name}`;

            await loadLog(); // Nejprve stÃ¡hneme data
            
        } catch (e) {
            console.error("Chyba pÅ™i naÄÃ­tÃ¡nÃ­ serverÅ¯:", e);
            showError(`NepodaÅ™ilo se naÄÃ­st servery: ${e.message}`);
        }
    }

    async function handleGuildChange() {
        const select = document.getElementById('guildSelect');
        const authButtonLg = document.getElementById('authButtonLg'); 
        const authButtonSm = document.getElementById('authButtonSm'); 
        const newId = select.value;
        
        if (newId && newId !== currentGuildId) {
            currentGuildId = newId;
            const guildName = select.options[select.selectedIndex].text;
            document.getElementById('serverInfo').textContent = `Audit Log pro server: ${guildName}`;
            
            const newPath = `/auditlog/${newId}`;
            window.history.pushState({ guildId: newId }, '', newPath);

            // --- OPRAVA ZDE: Aktualizujeme auth URL po zmÄ›nÄ› serveru ---
            const newAuthUrl = `${API_BASE_URL}/api/auth/discord?next=${encodeURIComponent(newPath)}`;
            authButtonLg.href = newAuthUrl;
            authButtonSm.href = newAuthUrl;
            
            await loadLog(); // ZmÄ›na serveru vyÅ¾aduje novÃ© staÅ¾enÃ­ dat
        }
    }


    // --- Inicializace ---
    document.addEventListener('DOMContentLoaded', () => {
        generateEventFilters();
        loadInitialData();
    });

</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
</body>
</html>
