<!DOCTYPE html>
<html lang="cs" data-bs-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Statistiky Discord Serveru</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/countup.js/2.2.0/countUp.min.js"></script>

<style>
body { background:#1e1e2d; color:#d1d1d1; font-family:'Poppins',sans-serif; }
.header-section { background:#2a2a3e; padding:40px 0; border-bottom:2px solid #5a5a7a; box-shadow:0 4px 6px rgba(0,0,0,0.2); position:relative; z-index: 100; }
h2.section-title { font-weight:700; font-size:2rem; background:linear-gradient(90deg,#57F287,#3498db); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:1.5rem; }
.card { background:rgba(42,42,62,0.65); backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.1); border-radius:16px; transition:all 0.3s ease; color:#ffffff; opacity:0; transform:translateY(20px); }
.card.show { opacity:1; transform:translateY(0); transition:all 0.5s ease; }
.chart-container { height:350px; }
/* Upraven√Ω styl pro seznamy: Kompaktnƒõj≈°√≠ zobrazen√≠ */
.list-group-item.card { 
    border:none; 
    border-radius:12px; 
    margin-bottom:4px; /* Zmen≈°ena mezera */
    padding:10px 15px; /* Zmen≈°ena v√Ω≈°ka */
    background:rgba(42,42,62,0.5);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.95rem; /* M√≠rnƒõ men≈°√≠ p√≠smo */
}
/* Nov√Ω styl pro Reputaci */
.rep-list-item {
    padding: 5px 0;
    display: flex;
    justify-content: space-between;
    font-family: 'Roboto Mono', monospace; /* Monospace pro lep≈°√≠ zarovn√°n√≠ ƒç√≠sel */
}
.rep-list-item:not(:last-child) {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}
.rep-list-item .rank {
    font-size: 0.8rem;
    font-weight: 700;
    width: 30px;
}
.rep-list-item .name {
    flex-grow: 1;
    margin-left: 10px;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.rep-list-item .value {
    min-width: 50px;
    text-align: right;
    font-weight: 700;
}
.rep-list-item .value.positive { color: #57F287; }
.rep-list-item .value.negative { color: #F23F43; }

.form-select, .form-control { border-color:#5a5a7a; background-color:#2a2a3e !important; color:#d1d1d1 !important; }
.status-online { color:#57F287; } .status-idle { color:#FAA81A; } .status-dnd { color:#F23F43; } .status-offline { color:#747F8D; }
.animate-spin { animation:spin 1s linear infinite; }
@keyframes spin { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
#authButton { position:absolute; top:5px; right:15px; z-index:110; }

/* Nov√© styly pro footer */
.footer { background:#2a2a3e; padding:20px 0; border-top:1px solid #5a5a7a; margin-top:50px; text-align:center; }
.footer p { margin-bottom:0; font-size:0.9rem; color:#9faab7; }

/* --- SPINNER STYLY --- */
#loadingMessage {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    height: 30vh;
    color: #3498db;
    font-size: 1.25rem;
}
.loading-hidden {
    display: none !important;
}

/* --- CHYBOV√ù PLACEHOLDER STYLY --- */
.chart-error-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 200px; /* Zaji≈°tƒõn√≠ viditeln√© v√Ω≈°ky, i kdy≈æ chart-container nem√° pevnou v√Ω≈°ku */
    border: 2px dashed #FAA81A; /* Upozornƒõn√≠ barva */
    background: rgba(250, 168, 26, 0.1);
    border-radius: 12px;
    padding: 20px;
    color: #FAA81A;
}

</style>
</head>
<body>

<header class="header-section text-center">
<div class="container">
  <a href="/api/auth/discord" class="btn btn-outline-info rounded-pill" id="authButton" title="P≈ôihl√°sit znovu p≈ôes Discord.">
    <i class="bi bi-discord me-2"></i> P≈ôihl√°sit se
  </a>
  <h1 id="serverName" class="display-4 fw-bold text-info"><i class="bi bi-disc-fill me-3"></i>Naƒç√≠t√°n√≠ statistik...</h1>
  <p id="periodDisplay" class="lead text-secondary mt-3">Naƒç√≠t√°m data...</p>
</div>
</header>

<main class="container py-5">

<div class="mb-5 d-flex flex-column flex-md-row align-items-md-center justify-content-between g-3">
  <div class="d-flex align-items-center flex-wrap mb-3 mb-md-0">
    <label for="guildSelect" class="form-label mb-0 me-3 fs-5">Zobrazit server:</label>
    <select id="guildSelect" class="form-select w-auto bg-dark text-light" onchange="handleGuildChange()">
      <option value="">Naƒç√≠t√°n√≠ server≈Ø...</option>
    </select>
  </div>
  <div class="d-flex align-items-center flex-wrap">
    <label for="periodSelect" class="form-label mb-0 me-3 fs-5">Zobrazit za:</label>
    <select id="periodSelect" class="form-select w-auto bg-dark text-light" onchange="loadStats(currentGuildId)">
      <option value="24h">Posledn√≠ch 24 hodin</option>
      <option value="7d" selected>Posledn√≠ch 7 dn√≠</option>
      <option value="1m">Posledn√≠ mƒõs√≠c</option>
      <option value="all">Celkov√° doba</option>
    </select>
  </div>
</div>

<div id="loadingMessage" style="display:none;">
    <div class="spinner-border text-info mb-3" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Naƒç√≠t√°n√≠...</span>
    </div>
    <span id="loadingText">Naƒç√≠t√°m statistiky...</span>
</div>

<div id="statsContent" class="loading-hidden"> 
    
    <h2 class="section-title"><i class="bi bi-activity me-2"></i> Celkov√Ω P≈ôehled Aktivity</h2>
    <div class="row g-4 mb-5" id="overallStatsCards">
        
        <div class="col-lg col-md-6"><div class="card p-3"><div class="card-body"><h5 class="card-title text-secondary">Aktivn√≠ ƒålenov√©</h5><p class="card-text fs-2 fw-bold text-info" id="liveMembers">-</p></div></div></div>
        
        <div class="col-lg col-md-6"><div class="card p-3"><div class="card-body"><h5 class="card-title text-secondary">Celkem ƒålen≈Ø</h5><p class="card-text fs-2 fw-bold text-secondary" id="totalMembers">-</p></div></div></div>
        
        <div class="col-lg col-md-6"><div class="card p-3"><div class="card-body"><h5 class="card-title text-secondary">Zpr√°v Celkem</h5><p class="card-text fs-2 fw-bold text-warning" id="totalMessages">-</p></div></div></div>
        
        <div class="col-lg col-md-6"><div class="card p-3"><div class="card-body"><h5 class="card-title text-secondary">Hlasov√° Aktivita</h5><p class="card-text fs-2 fw-bold text-success" id="totalVoiceDuration">-</p></div></div></div>
        
        <div class="col-lg col-md-6"><div class="card p-3"><div class="card-body"><h5 class="card-title text-secondary">P≈ô√≠chody/Odchody</h5><p class="card-text fs-2 fw-bold" id="joinLeaveStats"><span class="text-success" id="joins">-</span> / <span class="text-danger" id="leaves">-</span></p></div></div></div>
    </div>
    
    <h2 class="section-title mt-5"><i class="bi bi-graph-up me-2"></i> Denn√≠ aktivita zpr√°v</h2>
    <div class="row g-4 mb-5">
      <div class="col-12">
        <div class="card p-4 show">
          <h4 class="card-title mb-4">Zpr√°vy v ƒçase (<span id="dailyChartPeriod"></span>)</h4>
          <div class="chart-container" id="dailyMessagesChartContainer">
            <canvas id="dailyMessagesChart"></canvas>
          </div>
        </div>
    </div>
    </div>

        <h2 class="section-title mt-5"><i class="bi bi-people-fill me-2"></i> V√Ωvoj Poƒçtu ƒålen≈Ø</h2>
    <div class="row g-4 mb-5">
      <div class="col-12">
        <div class="card p-4 show">
          <h4 class="card-title mb-4">Historick√Ω poƒçet ƒçlen≈Ø (server)</h4>
          <div class="chart-container" id="memberEvolutionChartContainer">
            <canvas id="memberEvolutionChart"></canvas>
          </div>
          <small class="text-secondary mt-3">Pozn√°mka: Ukl√°d√°n√≠ poƒçtu ƒçlen≈Ø prob√≠h√° jednou za 24h..</small>
        </div>
      </div>
    </div>
<h2 class="section-title mt-5"><i class="bi bi-trophy-fill me-2"></i> Top Aktivita</h2>

    <div class="row g-5 mb-5">
    <div class="col-lg-6">
                <div class="card p-4 show mb-5">
            <h4 class="card-title mb-4">üëë Top 10 U≈æivatel≈Ø (Zpr√°vy)</h4>
            <div class="chart-container" id="topUsersMessagesChartContainer" style="height: 250px;">
                <canvas id="topUsersMessagesChart"></canvas>
            </div>
            <small class="text-secondary mt-3">Pozn.: * = U≈æivatel nen√≠ na serveru</small>
        </div>

                <div class="card p-4 show mb-5">
            <h4 class="card-title mb-4">üé§ Top 10 U≈æivatel≈Ø (Hlas)</h4>
            <div class="chart-container" id="topUsersVoiceChartContainer" style="height: 250px;">
                <canvas id="topUsersVoiceChart"></canvas>
            </div>
            <small class="text-secondary mt-3">Celkov√° doba v hlasov√©m kan√°le.</small>
        </div>

                <div class="card p-4 show mb-5">
            <h4 class="card-title mb-4">‚≠ê Top 10 U≈æivatel≈Ø (XP)</h4>
            <div class="chart-container" id="topUsersXPChartContainer" style="height: 250px;">
                <canvas id="topUsersXPChart"></canvas>
            </div>
            <small class="text-secondary mt-3">Celkov√° z√≠skan√° zku≈°enost (XP).</small>
        </div>
        
                <div class="card p-4 show mb-5">
            <h4 class="card-title mb-4">‚ú® Top 10 U≈æivatel≈Ø (Reputace +)</h4>
            <div id="topUsersPositiveRepChartContainer" class="list-group list-group-flush">
                            </div>
            <small class="text-secondary mt-3">U≈æivatel√© s nejvy≈°≈°√≠ celkovou reputac√≠.</small>
        </div>

            </div> 
        <div class="col-lg-6">
                <div class="card p-4 show mb-5">
            <h4 class="card-title mb-4">üí¨ Top Kan√°ly (Zpr√°vy)</h4>
            <div class="list-group list-group-flush" id="topChannelsList">
                <div class="text-center p-5 text-secondary">Naƒç√≠t√°m kan√°ly...</div>
            </div>
        </div>
    
                        <div class="card p-4 show mb-5"> 
            <h4 class="card-title mb-4">üü¢ Aktu√°ln√≠ Online Stavy</h4>
            <div class="chart-container d-flex justify-content-center" id="onlineStatusChartContainer" style="height: 250px;">
                <canvas id="onlineStatusChart" style="max-height:250px;"></canvas>
            </div>
        </div>
        
                <div class="card p-4 show mb-5">
            <h4 class="card-title mb-4">üí£ Top 10 U≈æivatel≈Ø (Reputace -)</h4>
            <div id="topUsersNegativeRepChartContainer" class="list-group list-group-flush">
                            </div>
            <small class="text-secondary mt-3">U≈æivatel√© s nejni≈æ≈°√≠ celkovou reputac√≠. * = U≈æivatel nen√≠ na serveru</small>
        </div>
        
    </div>
        </div>
</div>
</main>

<footer class="footer">
  <div class="container">
    <p>&copy; 2025 Discord Stats Dashboard. Made by <span class="text-info fw-bold">papiscze</span>.</p>
    <p>Dashboard Version: 1.2</p>
    <p>Dashboard Update: 1.3 (Reputation Charts)</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_BASE_URL = window.location.origin;
const BOT_INVITE_URL = 'https://discord.com/oauth2/authorize?client_id=902877191086420008&permissions=0&scope=bot%20applications.commands'; 
let currentGuildId = null;
let charts = {};

Chart.defaults.color = '#d1d1d1';
Chart.defaults.borderColor = '#5a5a7a';

// Z√≠sk√°n√≠ element≈Ø
const statsContent = document.getElementById('statsContent');
const loadingMessage = document.getElementById('loadingMessage');
const serverNameElement = document.getElementById('serverName');
const periodDisplayElement = document.getElementById('periodDisplay');

// --- Funkce pro spinner (beze zmƒõny) ---
function showLoading(message = "Naƒç√≠t√°m statistiky...") {
    // Skryjeme data a zobraz√≠me spinner
    statsContent.classList.add('loading-hidden');
    loadingMessage.style.display = 'flex';
    document.getElementById('loadingText').textContent = message;
    
    // Nastav√≠me √∫vodn√≠ text v hlaviƒçce
    serverNameElement.innerHTML = `üìä<i class="bi bi-arrow-clockwise me-2 animate-spin"></i>Naƒç√≠t√°m data...`;
    periodDisplayElement.textContent = "ƒåek√°m na odpovƒõƒè serveru...";
}

function hideLoading(success = true, serverName = null, periodDisplay = null) {
    loadingMessage.style.display = 'none';

    if (success) {
        // Zobraz√≠me data (nastav√≠ se v loadStats)
        statsContent.classList.remove('loading-hidden');
        if (serverName) serverNameElement.innerHTML = `üìä Statistiky serveru "${serverName}"`;
        if (periodDisplay) periodDisplayElement.textContent = periodDisplay;
        
        // Znovu-zobrazen√≠ v≈°ech karet s animac√≠
    document.querySelectorAll('.card').forEach(c=>c.classList.add('show'));
    } else {
        // Chybov√© hl√°≈°ky se nastav√≠ p≈ô√≠mo ve funkc√≠ch loadInitialData/loadStats
    }
}
// --- Konec funkc√≠ pro spinner ---

// --- Funkce pro zobrazen√≠ chyby v grafu (beze zmƒõny) ---
/**
 * Vytvo≈ô√≠ HTML placeholder pro chybu v grafu.
 * @param {string} message - Konkr√©tn√≠ chybov√° zpr√°va.
 * @returns {string} HTML ≈ôetƒõzec.
 */
function renderErrorPlaceholder(message) {
    return `
        <div class="chart-error-placeholder">
            <i class="bi bi-exclamation-triangle-fill fs-3 mb-2"></i>
            <p class="fw-bold mb-1">DATA NEDOSTUPN√Å</p>
            <p class="text-center text-sm">${message}</p>
        </div>
    `;
}

/**
 * Resetuje kontejner a vr√°t√≠ HTML pro nov√Ω canvas.
 * @param {string} containerId - ID kontejneru (nap≈ô. 'dailyMessagesChartContainer').
 * @param {string} canvasId - ID canvasu (nap≈ô. 'dailyMessagesChart').
 * @returns {HTMLElement} Novƒõ vytvo≈ôen√Ω canvas element.
 */
function resetChartContainer(containerId, canvasId) {
    const container = document.getElementById(containerId);
    container.innerHTML = `<canvas id="${canvasId}"></canvas>`;
    return document.getElementById(canvasId);
}
// --- Konec funkc√≠ pro zobrazen√≠ chyby v grafu ---


async function handleGuildChange() { 
  const select=document.getElementById('guildSelect'); 
  const newId=select.value; 
  if(newId && newId !== currentGuildId) {
    currentGuildId=newId; 
    window.history.pushState({guildId:newId},'',`/stats/${newId}`); 
    
    const guildName = select.options[select.selectedIndex].text;
    await loadStats(newId, guildName);
  } 
}

async function loadInitialData() {
    showLoading("Kontroluji p≈ô√≠stup..."); // Zobrazit spinner
    
  const select=document.getElementById('guildSelect'), authButton=document.getElementById('authButton');
  select.innerHTML=`<option value="">Naƒç√≠t√°m servery...</option>`; select.disabled=true;
  
  // Zde nevol√°me hideLoading, proto≈æe buƒè p≈ôejdeme na loadStats, nebo je chyba
  document.querySelectorAll('.card').forEach(c => c.classList.remove('show')); 
  
  try {
    const response=await fetch(`${API_BASE_URL}/api/user/authorized_guilds`);
    
    if(!response.ok){ 
      loadingMessage.style.display = 'none'; // Skryjeme spinner
      authButton.innerHTML=`<i class="bi bi-discord me-2"></i> P≈ôihl√°sit se`; 
      authButton.href=`${API_BASE_URL}/api/auth/discord?next=${encodeURIComponent(window.location.pathname)}`; 
      serverNameElement.innerHTML=`<i class="bi bi-lock-fill me-3"></i>Nep≈ôihl√°≈°en.`; 
      periodDisplayElement.textContent=`Pro zobrazen√≠ statistik se pros√≠m p≈ôihlaste.`; 
      select.innerHTML=`<option value="">Nep≈ôihl√°≈°en</option>`; 
      return; 
    }
    
    authButton.innerHTML=`<i class="bi bi-arrow-counterclockwise me-2"></i> Obnovit p≈ô√≠stup`; 
    authButton.href=`${API_BASE_URL}/api/auth/discord?next=${encodeURIComponent(window.location.pathname)}`;
    
    const authorizedGuilds=await response.json();
    
    if(!authorizedGuilds||authorizedGuilds.length===0){ 
      loadingMessage.style.display = 'none'; // Skryjeme spinner
      serverNameElement.innerHTML=`<i class="bi bi-x-octagon-fill me-3"></i>Nem√°te p≈ô√≠stup.`; 
      periodDisplayElement.textContent=`Ujistƒõte se, ≈æe jste spr√°vce serveru.`; 
      select.innerHTML=`<option value="">≈Ω√°dn√© servery</option>`; 
      return; 
    }
    
    select.innerHTML=authorizedGuilds.map(g=>`<option value="${g.id}">${g.name}</option>`).join('');
    select.disabled=false;
    
    let initialGuild = authorizedGuilds.find(g=>g.id===window.location.pathname.split('/').pop()) || authorizedGuilds[0];
    currentGuildId = initialGuild.id; select.value = initialGuild.id;
    window.history.replaceState({guildId:initialGuild.id},'',`/stats/${initialGuild.id}`);
    
    await loadStats(initialGuild.id, initialGuild.name);
  } catch(e){ 
    console.error("Chyba:",e); 
    loadingMessage.style.display = 'none'; // Skryjeme spinner
    serverNameElement.innerHTML=`<i class="bi bi-x-octagon-fill me-3"></i>Chyba.`; 
    periodDisplayElement.textContent=`Nepoda≈ôilo se naƒç√≠st servery: ${e.message}`; 
  }
}

async function loadStats(guildId, guildName = "Nezn√°m√Ω Server"){
  if(!guildId) return;
  showLoading(`Naƒç√≠t√°m statistiky pro server...`); // Zobrazit spinner a aktualizovat text
  
  const period=document.getElementById('periodSelect').value;
  const url=`${API_BASE_URL}/api/stats/${guildId}?period=${period}`;

  // D≈Øle≈æit√©: skryjeme karty pro animaci
  document.querySelectorAll('.card').forEach(c => c.classList.remove('show')); 

  try{
    const response=await fetch(url); 
    
    if(!response.ok) {
      loadingMessage.style.display = 'none'; // Skryjeme spinner

      // Zobrazen√≠ chyby 404 (Bot nen√≠ na serveru)
      if (response.status === 404) {
        serverNameElement.innerHTML = `<i class="bi bi-robot me-3"></i> Bot nen√≠ na serveru: "${guildName}"`;
        periodDisplayElement.innerHTML = `
          <span class="text-danger">Pro zobrazen√≠ statistik mus√≠ b√Ωt bot p≈ô√≠tomen na serveru.</span><br>
          <a href="${BOT_INVITE_URL}" target="_blank" class="btn btn-outline-success mt-3">
            <i class="bi bi-discord me-2"></i> Pozvat Bota na Server
          </a>
        `;
        return; // Zastav√≠ zpracov√°n√≠
      }
      throw new Error(`Server: ${response.status}`);
    }
    
    const data=await response.json();
    
    // --- √öSPƒö≈†N√â ZOBRAZEN√ç DAT (beze zmƒõny) ---
    const statMap = {
      'liveMembers': 'live_members_count',
      'totalMembers': 'member_count',
      'totalMessages': 'total_messages',
      'totalVoiceDuration': 'total_voice_duration_seconds',
      'joins': 'joins',
      'leaves': 'leaves'
    };
    
    Object.keys(statMap).forEach(htmlId => {
      const apiKey = statMap[htmlId];
      const value = data.overall_stats[apiKey] || 0;
      
      // Speci√°ln√≠ zpracov√°n√≠ pro Hlasovou aktivitu, aby se zobrazilo form√°tov√°n√≠
      if (htmlId === 'totalVoiceDuration') {
        // Zobraz√≠me form√°tovan√Ω ƒças, ne jen sekundy
        document.getElementById(htmlId).textContent = formatTimeTicks(value); 
        // Animujeme jen, pokud m√°me countUp
        if (window.CountUp) new CountUp(htmlId, value).start();
      } else if (htmlId === 'joins' || htmlId === 'leaves') {
        // P≈ôipojen√≠/Odchody se animuj√≠ ve sv√© vlastn√≠ sekci
        if(window.CountUp) new CountUp(htmlId, value).start();
        else document.getElementById(htmlId).textContent = value;
      } else {
        // Standardn√≠ ƒç√≠taƒçe
        if(window.CountUp) new CountUp(htmlId, value).start();
        else document.getElementById(htmlId).textContent = value;
      }
    });
    
    const channelList=document.getElementById('topChannelsList');
    if(data.top_channels_messages && data.top_channels_messages.length>0) channelList.innerHTML=data.top_channels_messages.map((item,index)=>`<li class="list-group-item d-flex justify-content-between align-items-center card"><span class="fw-bold text-info">${index+1}. #${item.name}</span><span class="badge bg-primary rounded-pill">${item.count.toLocaleString()} zpr√°v (s)</span></li>`).join('');
    else channelList.innerHTML=`<div class="text-center p-3 text-secondary">≈Ω√°dn√° data pro kan√°ly.</div>`;

    // --- ZAVOL√ÅN√ç FUNKC√ç PRO VYKRESLEN√ç GRAF≈Æ S KONTROLOU CHYB (beze zmƒõny) ---
    renderDailyActivityChart(data.daily_message_activity, data.period_display);
    renderMemberEvolutionChart(data.member_evolution); 
    
    renderTopUsersChart(data.top_users_messages, 'topUsersMessagesChart', 'topUsersMessagesChartContainer', 'Zpr√°vy', 'rgba(255,193,7,0.7)', false, 'count');
    renderTopUsersChart(data.top_users_voice, 'topUsersVoiceChart', 'topUsersVoiceChartContainer', 'Hlas (s)', 'rgba(40,167,69,0.7)', true, 'duration_seconds');
    // Zde vol√°me XP graf, data mus√≠ obsahovat property 'xp' a 'level'
    renderTopUsersChart(data.xp_leaderboard, 'topUsersXPChart', 'topUsersXPChartContainer', 'XP', 'rgba(175, 87, 242, 0.7)', false, 'xp');

    // === NOV√Å VOL√ÅN√ç PRO REPUTACI - NYN√ç JAKO KOMPAKTN√ç LISTY ===
    renderReputationList(data.rep_positive_leaderboard, 'topUsersPositiveRepChartContainer', '+');
    renderReputationList(data.rep_negative_leaderboard, 'topUsersNegativeRepChartContainer', '-');
    // ================================================

    renderOnlineStatusChart(data.online_stats);
    
    hideLoading(true, data.server_name, `Statistiky za ${data.period_display}.`);
  } catch(e){ 
    console.error("Chyba:",e); 
    loadingMessage.style.display = 'none'; // Skryjeme spinner
    serverNameElement.innerHTML=`<i class="bi bi-x-octagon-fill me-3"></i>Chyba p≈ôi naƒç√≠t√°n√≠ dat.`; 
    periodDisplayElement.textContent=`${e.message}`; 
  }
}

// === AKTUALIZOVAN√Å FUNKCE PRO VYKRESLEN√ç REPUTACE JAKO KOMPAKTN√çHO SEZNAMU ===
/**
 * Vykresl√≠ data reputace jako kompaktn√≠ seznam (rank, jm√©no, hodnota na jednom ≈ô√°dku).
 * @param {Array} repData - Data ≈æeb≈ô√≠ƒçku reputace.
 * @param {string} containerId - ID kontejneru pro vlo≈æen√≠ seznamu.
 * @param {string} repType - Typ reputace (+ nebo -) pro form√°tov√°n√≠.
 */
function renderReputationList(repData, containerId, repType) {
    const container = document.getElementById(containerId);
    
    // Zniƒçen√≠ existuj√≠c√≠ch graf≈Ø, pokud n√°hodou existuj√≠ (prevence)
    const chartId = containerId.replace('Container', '');
    if (charts[chartId]) charts[chartId].destroy();

    if (!repData || !Array.isArray(repData) || repData.length === 0) {
        container.innerHTML = renderErrorPlaceholder(`≈Ω√°dn√° data o reputaci ${repType} k zobrazen√≠.`);
        return;
    }

    const valueClass = repType === '+' ? 'positive' : 'negative';
    const repPrefix = repType === '+' ? '+' : ''; 

    // Generov√°n√≠ HTML pro kompaktn√≠ seznam
    const listHtml = repData.map((item) => {
        const isOffServer = item.on_server === false ? ' *' : '';
        const nameText = `${item.name}${isOffServer}`;

        return `
            <div class="rep-list-item">
                <span class="rank text-secondary">${item.rank}.</span>
                <span class="name text-light">${nameText}</span>
                <span class="value ${valueClass}">${repPrefix}${item.rep.toLocaleString()}</span>
            </div>
        `;
    }).join('');

    // Vlo≈æen√≠ seznamu do kontejneru
    container.innerHTML = `<div>${listHtml}</div>`;
}
// =========================================================

// Ostatn√≠ funkce beze zmƒõny (renderTopUsersChart, renderDailyActivityChart, renderMemberEvolutionChart, renderOnlineStatusChart, formatTimeTicks)
function renderTopUsersChart(usersData, canvasId, containerId, label, color, isTime = false, valueKey = 'count'){
    const container = document.getElementById(containerId);
    
    if (!usersData || !Array.isArray(usersData) || usersData.length === 0) {
        if (charts[canvasId]) charts[canvasId].destroy();
        container.innerHTML = renderErrorPlaceholder(`≈Ω√°dn√° data pro top u≈æivatele v kategorii ${label}.`);
        return;
    }
    
    // Reset kontejneru a z√≠sk√°n√≠ nov√©ho canvas elementu
    const ctx = resetChartContainer(containerId, canvasId).getContext('2d');

    if(charts[canvasId]) charts[canvasId].destroy();
    usersData=usersData.slice(0,10);
    
    // Zjist√≠me, jestli se jedn√° o XP ≈æeb≈ô√≠ƒçek
    const isXPChart = canvasId === 'topUsersXPChart';

    // Vytvo≈ô√≠me popisky, kter√© pro XP ≈æeb≈ô√≠ƒçek zahrnou i √∫rove≈à
    const labels = usersData.map(u => {
        let name = u.name + (u.on_server ? '' : ' *');
        
        // Pokud je to XP ≈æeb≈ô√≠ƒçek a data obsahuj√≠ 'level', p≈ôid√°me ho k popisku
        if (isXPChart && u.level !== undefined) {
            name += ` (Lvl ${u.level})`;
        }
        return name;
    });

    charts[canvasId]=new Chart(ctx,{
        type:'bar',
        data:{
            labels: labels, // Pou≈æit√≠ upraven√Ωch popisk≈Ø, kter√© zahrnuj√≠ i √∫rove≈à
            datasets:[{
                label,
                data:usersData.map(u=>u[valueKey]),
                backgroundColor:color
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            indexAxis:'y',
            scales:{
                x:{
                    beginAtZero:true,
                    grid:{color:'#3a3a5a'},
                    ticks:{callback:isTime?formatTimeTicks:undefined}
                },
                y:{
                    grid:{color:'#3a3a5a'}
                }
            },
            plugins:{
                legend:{display:false}
            },
            animation:{
                duration:1000,
                easing:'easeOutQuart'
            }
        }
    });
}

let dailyMessagesChartInstance=null;
function renderDailyActivityChart(activityData,periodDisplay){
    const containerId = 'dailyMessagesChartContainer';
    const canvasId = 'dailyMessagesChart';
    const container = document.getElementById(containerId);

    if (!activityData || !Array.isArray(activityData) || activityData.length === 0) {
        if (dailyMessagesChartInstance) dailyMessagesChartInstance.destroy();
        container.innerHTML = renderErrorPlaceholder("≈Ω√°dn√° data o denn√≠ aktivitƒõ zpr√°v v tomto obdob√≠.");
        document.getElementById('dailyChartPeriod').textContent = periodDisplay;
        return;
    }

    // Reset kontejneru a z√≠sk√°n√≠ nov√©ho canvas elementu
    const ctx = resetChartContainer(containerId, canvasId).getContext('2d');

    if(dailyMessagesChartInstance) dailyMessagesChartInstance.destroy();
    const labels=activityData.map(item=>item.date), dataCounts=activityData.map(item=>item.count);
    const gradient=ctx.createLinearGradient(0,0,0,350); gradient.addColorStop(0,'rgba(52,152,219,0.5)'); gradient.addColorStop(1,'rgba(52,152,219,0.05)');
    dailyMessagesChartInstance=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Poƒçet zpr√°v',data:dataCounts,backgroundColor:gradient,borderColor:'#3498db',borderWidth:3,tension:0.4,fill:true,pointRadius:4,pointHoverRadius:6,pointBackgroundColor:'#3498db'}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{type:'time',time:{unit:'day',tooltipFormat:'dd. MM. yyyy',displayFormats:{day:'dd. MM.'}},grid:{color:'#3a3a5a'},title:{display:true,text:'Datum'}},y:{beginAtZero:true,grid:{color:'#3a3a5a'},title:{display:true,text:'Poƒçet zpr√°v'}}},animation:{duration:1200,easing:'easeOutQuart'}}});
    document.getElementById('dailyChartPeriod').textContent=periodDisplay;
}

// NOV√Å FUNKCE PRO V√ùVOJ POƒåTU ƒåLEN≈Æ 
let memberEvolutionChartInstance=null;
function renderMemberEvolutionChart(evolutionData){
    const containerId = 'memberEvolutionChartContainer';
    const canvasId = 'memberEvolutionChart';
    const container = document.getElementById(containerId);

    if (!evolutionData || !Array.isArray(evolutionData) || evolutionData.length === 0) {
        if (memberEvolutionChartInstance) memberEvolutionChartInstance.destroy();
        container.innerHTML = renderErrorPlaceholder("Historick√° data o poƒçtu ƒçlen≈Ø nejsou k dispozici.");
        return;
    }

    // Reset kontejneru a z√≠sk√°n√≠ nov√©ho canvas elementu
    const ctx = resetChartContainer(containerId, canvasId).getContext('2d');
    
    if(memberEvolutionChartInstance) memberEvolutionChartInstance.destroy();
    const labels = evolutionData.map(item => item.date);
    const dataCounts = evolutionData.map(item => item.count);
     
    const gradient=ctx.createLinearGradient(0,0,0,350); 
    gradient.addColorStop(0,'rgba(87,242,135,0.5)'); 
    gradient.addColorStop(1,'rgba(87,242,135,0.05)');

    memberEvolutionChartInstance=new Chart(ctx,{
        type:'line',
        data:{
          labels,
          datasets:[{
            label:'Poƒçet ƒålen≈Ø',
            data:dataCounts,
            backgroundColor:gradient,
            borderColor:'#57F287',
            borderWidth:3,
            tension:0.4,
            fill:true,
            pointRadius:4,
            pointHoverRadius:6,
            pointBackgroundColor:'#57F287'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            x:{
              type:'time',
              time:{
                unit:'day',
                tooltipFormat:'dd. MM. yyyy',
                displayFormats:{day:'dd. MM.'}
              },
              grid:{color:'#3a3a5a'},
              title:{display:true,text:'Datum'}
            },
            y:{
              beginAtZero:true, 
              grid:{color:'#3a3a5a'},
              title:{display:true,text:'Poƒçet ƒålen≈Ø'},
              // Zaji≈°tƒõn√≠ cel√Ωch ƒç√≠sel na ose Y pro poƒçet ƒçlen≈Ø
              ticks: {
                precision: 0 
              }
            }
          },
          plugins:{
            tooltip: {
              callbacks: {
                label: function(context) {
                  return ' ' + context.dataset.label + ': ' + context.parsed.y.toLocaleString();
                }
              }
            }
          },
          animation:{duration:1200,easing:'easeOutQuart'}
        }
     });
}


function renderOnlineStatusChart(statusData){
    const canvasId='onlineStatusChart';
    const containerId = 'onlineStatusChartContainer';
    const container = document.getElementById(containerId);
    
    // Kontrola, zda data existuj√≠ a maj√≠ alespo≈à jednu kladnou hodnotu
    const hasData = statusData && Object.values(statusData).some(count => count > 0);

    if (!hasData) {
        if (charts[canvasId]) charts[canvasId].destroy();
        container.innerHTML = renderErrorPlaceholder("≈Ω√°dn√° data o online stavech ƒçlen≈Ø.");
        return;
    }

    // Reset kontejneru (pouze pokud existuje) a z√≠sk√°n√≠ nov√©ho canvas elementu
    const ctx = resetChartContainer(containerId, canvasId).getContext('2d');
    
    if(charts[canvasId]) charts[canvasId].destroy();
    const statuses=[{key:'online',label:'Online',color:'#57F287'},{key:'idle',label:'Neaktivn√≠',color:'#FAA81A'},{key:'dnd',label:'Neru≈°it',color:'#F23F43'},{key:'offline',label:'Offline/Neviditeln√Ω',color:'#747F8D'}].filter(s=>statusData[s.key]>0);
    charts[canvasId]=new Chart(ctx,{type:'doughnut',data:{labels:statuses.map(s=>s.label),datasets:[{data:statuses.map(s=>statusData[s.key]),backgroundColor:statuses.map(s=>s.color),hoverOffset:10,borderColor:'#1e1e2d',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{padding:10}},tooltip:{callbacks:{label:ctx=>{const value=ctx.parsed;const total=ctx.dataset.data.reduce((a,b)=>a+b,0);const percent=total>0?((value/total)*100).toFixed(1)+'%':'0%'; return `${ctx.label}: ${value} (${percent})`;}}}},animation:{duration:1000,easing:'easeOutQuart'}}});
}

function formatTimeTicks(value){
  const seconds=Math.floor(value),d=Math.floor(seconds/(3600*24)),h=Math.floor((seconds%(3600*24))/3600),m=Math.floor((seconds%3600)/60),s=seconds%60;
  let result=''; 
  if(d>0) result+=`${d}d `; 
  if(h>0) result+=`${h}h `; 
  if(m>0) result+=`${m}m `; 
  if(s>0&&d===0&&h===0&&m===0) result=`${s}s`; 
  return result.trim()||'0s';
}

document.addEventListener('DOMContentLoaded',loadInitialData);
</script>
</body>
</html>
